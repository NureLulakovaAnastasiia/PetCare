@page "/login"

@inject IAuthorizationService authService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime



<PageTitle>Login</PageTitle>


<div class="row text-center justify-content-center mt-5">

    @* <div class="text-danger">
    <p class="alert-primary">@error</p>
    </div> *@

    <div class="col-8 offset-4">
        @if (IsLogin)
        {
            <div class="col-7">
                <h1>With returning</h1>
                <EditForm Model="LoginModel" FormName="LoginForm" OnSubmit="LoginFunc" class="">
                    <div class="form-group py-2 text-center">
                        <h5>Email</h5>
                        <InputText class="form-control" @bind-Value="LoginModel.Email" DisplayName="Email" />
                        <h5>Password</h5>
                        <InputText typeof="password" class="form-control" @bind-Value="LoginModel.Password" />
                    </div>
                    <button type="submit" class="btn btn-primary col-10 mt-3">Login</button>
                </EditForm>
                <div class="mt-3">
                    <h6>Don't have an account? <a @onclick="() => SelectTab(false)">Register</a></h6>
                </div>
            </div>
        }
        else if (!IsLogin && !IsCode)
        {
            <div class="col-7">
                <h1>Create new account</h1>
                <EditForm Model="LoginModel" FormName="LoginForm" OnSubmit="RegisterFunc" class="">
                    <div class="form-group py-2 text-center">
                        <div class="row justify-content-between mb-3">
                            <div class="col-6">
                                <h5>First Name</h5>
                                <InputText class="form-control" @bind-Value="RegisterModel.FirstName" />
                            </div>
                            <div class="col-6">
                                <h5>Last Name</h5>
                                <InputText class="form-control" @bind-Value="RegisterModel.LastName" />
                            </div>
                        </div>
                        <div>
                            <h5>Choose your role</h5>
                            <div class="row justify-content-center">
                            <InputRadioGroup @bind-Value="role">
                                @foreach (var Erole in Enum.GetValues<Roles>())
                                {
                                    <div class="col-5">
                                        <label>
                                            <InputRadio Value="@Erole.ToString()" />
                                            @Erole
                                        </label>
                                    </div>
                                }
                            </InputRadioGroup>
                            </div>

                            <div class="mt-3">
                                <h5>Email</h5>
                                <InputText class="form-control" @bind-Value="RegisterModel.Email" />
                            </div>
                            <div class="mt-3">
                                <h5>Password</h5>
                                <InputText typeof="password" class="form-control" @bind-Value="RegisterModel.Password" />
                             </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary  col-10 mt-3">Register</button>
                </EditForm>
                <div class="mt-3">
                    <h6>Already have an account? <a @onclick="() => SelectTab(true)">Login</a></h6>
                </div>
            </div>
        }
        @if (IsCode)
        {
            <_EmailSubmit realCode="@realCode" email="@Email" />
        }
    </div>

</div>


@code {
    private bool IsLogin { get; set; } = true;
    private bool IsCode { get; set; } = false;

    [CascadingParameter]
    public Func<bool, Task> UpdateAuthenticationStatus { get; set; }

    public LoginDto LoginModel { get; set; } = new LoginDto();

    public RegisterDto RegisterModel { get; set; } = new RegisterDto();

    public string realCode { get; set; }
    public string role = "User";
    public string error = "";

    public string Email
    {
        get
        {
            if (LoginModel.Email != null)
            {
                return LoginModel.Email;
            }
            else if (RegisterModel.Email != null)
            {
                return RegisterModel.Email;
            }
            return "";
        }
    }

    public enum Roles
    {
        User,
        Organization

    }

    public async Task LoginFunc()
    {
        var result = await authService.Login(LoginModel);
        if (!String.IsNullOrEmpty(result.Error))
        {
            error = result.Error;
            if (result.StatusCode != null && result.StatusCode == 403)
            {
                realCode = result.Result;
                CheckForCode();
            }
        }
        else
        {
            await UpdateAuthenticationStatus(true);
            Navigation.NavigateTo("/");
        }
    }

    public async Task RegisterFunc()
    {
        var result = await authService.Register(RegisterModel, role);
        if (!String.IsNullOrEmpty(result.Error))
        {
            error = result.Error;
        }
        else
        {
            realCode = result.Result;
            CheckForCode();
        }
    }

    private void CheckForCode()
    {
        if (String.IsNullOrEmpty(realCode))
        {
            error = "Something went wrong"; //generate new?
        }
        else
        {
            IsLogin = false;
            IsCode = true;
        }
    }

    private void SelectTab(bool loginSelected)
    {
        IsLogin = loginSelected;
    }
}


<style>
    body {
        background: local url("../Images/background-2.svg") no-repeat top;
    }
</style>